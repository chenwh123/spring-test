---
theme: channing-cyan
highlight: a11y-dark
---

# 实现算术表达式解析 

> 声明： 本文代码使用java-JDK8
# 前言

今天刚好遇到一个需求，用户输入任意公式，返回计算结果。

例子:
```properties
工资 = "出勤天数 * 基本工资/当月工作日 + 绩效奖金 - 迟到早退扣钱"
```

这里分享一个解析运算表达式的方法，我这里使用的是递归下降解析器（recursive descent parser）的解析方法，这是一种自顶向下的解析方法。

# EBNF
首先介绍一下EBNF(扩展巴科斯范式 , Extended Backus–Naur Form) , 它是一种表达形式语言文法的代码。有点类似于正则表达式

简单举几个例子
```properties
# 表示字母 
letter = 'a'|'b'|'c'|'d'|'e'|'f'|'g'|'h'|'i'|'j'|'k'|'l'|'m'|'n'|'o'|'p'|'q'|'r'|'s'|'t'|'u'|'v'|'w'|'x'|'y'|'z'|'A'|'B'|'C'|'D'|'E'|'F'|'G'|'H'|'I'|'J'|'K'|'L'|'M'|'N'|'O'|'P'|'Q'|'R'|'S'|'T'|'U'|'V'|'W'|'X'|'Y'|'Z';
# 等同于letter = 'a' ... 'z' | 'A' ... 'Z' ;

# 表示数字 1-9
nonzero_digit = '1'...'9' | '0' ;

# 表示数字 0-9
digit =  '0' | nonzero_digit ;
# 表示单词
word = (letter | '_') { '_' | letter | digit } ;
# 表示整数
int = '0' | ['+'|'-'] nonzero_digit { digit } ;
```


- | : 表示或 
- ... : 表示范围，可用于表示连续的字符， 跟或类型
- { ... } 花括号表示出现0次或多次， 类似正则的*
- '' 表示字符串
- [] 表示可选，类似正则的?

# 基本运算公式的EBNF
通过上面的例子，大家应该大概明白ebnf的机制，这里我们写一下包含+-*/运算表达式的ebnf
```properties
double = int ['.' digit { digit }] ;
factor = double ;
term = factor { ('*'|'/') factor } ;
expression = term { ('+'|'-') term } ;
```

这里大家应该可以发现，优先级越高的运算符需要优先计算，+-优先级最低，因此放在最外层的expression中。在日常生活的口算中，我们应该也会把term中的*/优先计算，再做+-运算

如：
```properties
res = 1 + 2 * 3 + 4 * 5     \
    =  1 + 6 + 20
```

# 代码实现
到这里我们得出了运算表达式的ebnf，接下来我们来实现一个简单的解析器
```java
class SimpleExpressionParser {
    
}
```



# 参考资料
- [1] [维基百科：递归下降解析器](https://zh.wikipedia.org/wiki/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E8%A7%A3%E6%9E%90%E5%99%A8
- [2] [How to evaluate a math expression given in string form?] https://stackoverflow.com/questions/3422673/how-to-evaluate-a-math-expression-given-in-string-form
- [3] [实现一个简单的递归下降分析器] https://python3-cookbook.readthedocs.io/zh-cn/latest/c02/p19_writing_recursive_descent_parser.html
- [4] [巴科斯範式(BNF/EBNF/ABNF)] https://hackmd.io/@ShenTengTu/HJzCM3aDr
- [5] [The language of languages] https://matt.might.net/articles/grammars-bnf-ebnf/
- [6] [BNF Syntax Validator and Formatter] https://www.icosaedro.it/bnf_chk/#ebnfsyntax
- [7] [EBNF: A  Notation   to Describe  Syntax] https://ics.uci.edu/~pattis/ICS-33/lectures/ebnf.pdf